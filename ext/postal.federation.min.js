/*
 postal.federation
 Copyright (C) 2012 - Jim Cowart (http://freshbrewedcode.com/jimcowart)
 License: Dual licensed MIT & GPL v2.0
 Version 0.1.0
 */
(function(e,t){typeof module=="object"&&module.exports?module.exports=t(require("underscore"),require("postal")):typeof define=="function"&&define.amd?define(["underscore","postal"],function(n,r){return t(n,r,e)}):e.postal=t(e._,e.postal,e)})(this,function(e,t,n,r){var i={enabled:!0,constraintMode:"blacklist",bridgeSysChannel:!0},s=i,o=function(e){this.id=e,this.activeTransport=r};return o.prototype.send=function(e,t){t=t||this.activeTransport,t&&this[t].send(e)},t.fedx=e.extend({clients:{},transports:{},constraints:{},FederationClient:o,addClient:function(e,t){var n=this.clients[e.instanceId]||(this.clients[e.instanceId]=new o(e.instanceId));e.attachToClient(n),n.activeTransport=n.activeTransport||t},addConstraint:function(t,n){this.constraints[t]?e.include(this.constraints[t],n)||this.constraints[t].push(n):this.constraints[t]=[n]},removeConstraint:function(t,n){this.constraints[t]&&e.include(this.constraints[t],n)&&(this.constraints[t]=e.without(this.constraints[t],n))},canSendRemote:function(n,r){var i=this.constraints.hasOwnProperty(n),o=i&&e.any(this.constraints[n],function(e){return t.configuration.resolver.compare(e,r)}),u=s.constraintMode==="blacklist",a=!s.bridgeSysChannel&&n!==t.configuration.SYSTEM_CHANNEL||s.bridgeSysChannel;return s.enabled&&a&&(u&&(!i||i&&!o)||!u&&i&&o)},configure:function(t){if(t.constraintMode&&t.constraintMode!=="blacklist"&&t.mode!=="whitelist")throw new Error("postal.fedx constraintMode must be 'blacklist' or 'whitelist'.");return t&&(s=e.defaults(t,i)),s},onFederatedMsg:function(e,n){e.lastSender=n,t.publish(e)},send:function(n){n.originId=n.originId||t.instanceId,e.each(this.clients,function(t,r){var i=e.clone(n);r!==i.lastSender&&(!i.knownIds||!i.knownIds.length||i.knownIds&&!e.include(i.knownIds,r))&&(i.knownIds=(i.knownIds||[]).concat(e.without(e.keys(this.clients),r)),t.send(i))},this)},signalReady:function(t){t?this.transports[t].signalReady():e.each(this.transports,function(e){e.signalReady()},this)}},t.fedx),t.addWireTap(function(e,n){t.fedx.canSendRemote(n.channel,n.topic)&&t.fedx.send(n)}),t})